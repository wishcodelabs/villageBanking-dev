@page "/settings/investment-periods"
<AuthorizeView Roles="GroupAdmin">
    <Authorized>
        <MudContainer Class="mt-16 px-8 cont" MaxWidth="MaxWidth.False">
            <MudGrid Spacing="3" Justify="Justify.Center">
                <MudItem align="center" xs="12">
                    <MudPaper Elevation="20" Class="title-card p-4 ">
                        <MudText Class="text-white" Align="Align.Center" Typo="Typo.h5">Manage Investment Periods</MudText>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12">
                    <MudButton OnClick="ToggleAdd" Color="Color.Tertiary" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.PersonAdd">Add</MudButton>
                </MudItem>
                <MudItem xs="12">
                    <table class="table table-striped table-hover table-responsive-sm">
                        <caption>List of Investment Periods</caption>
                        <thead class="thead-dark">
                            <tr>
                               
                                <th>Begin Date</th>
                                <th>End Date</th>
                                <th>Duration</th>
                                <th>Minimum Amount</th>
                                <th>Date Created</th>
                                <th>Created By</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in DataSource)
                            {

                                TimeSpan duration = Convert.ToDateTime(item.EndDate).Subtract(Convert.ToDateTime(item.BeginDate));
                                Color color = (item.Status == PeriodStatus.Open) ? Color.Success : Color.Dark;
                                <tr class="text-white">
                                   
                                    <td>@Convert.ToDateTime(item.BeginDate).ToShortDateString()</td>
                                    <td>@Convert.ToDateTime(item.EndDate).ToShortDateString()</td>
                                    <td>@((int)duration.TotalDays) days </td>
                                    <td>@item.MinAmount ZMW</td>
                                    <td>@item.CreatedOn</td>
                                    <td>@item.CreatedBy</td>
                                    <td><MudChip title="Change status" OnClick="()=>Activate(item)" Size="Size.Small" Color="color" Text="@item.Status.ToString()" /></td>
                                    <td>
                                        <MudButton title="edit this record" OnClick="()=>ToggleEdit(item)" StartIcon="@Icons.Material.Filled.Edit" Size="Size.Small" Color="Color.Warning">Edit</MudButton>
                                        <MudButton title="Permanently delete this item?"  OnClick="()=>ToggleDelete(item)" StartIcon="@Icons.Material.Filled.DeleteForever" Size="Size.Small" Color="Color.Error">Delete</MudButton>
                                    </td>
                                </tr>
                            }
                        </tbody>

                    </table>
                </MudItem>
            </MudGrid>
        </MudContainer>
    </Authorized>
</AuthorizeView>
<style>
    body {
        background-color: #13262F;
    }

    .cont {
        background-color: #13262F;
    }

    .title-card {
        max-width: fit-content;
        border-radius: 10px;
        background-color: #13262F;
    }
</style>
@code {
    [CascadingParameter] Task<AuthenticationState> AuthenticationStateTask { get; set; }
    List<InvestmentPeriod> DataSource { get; set; } = new();
    ClaimsPrincipal claimsPrincipal = new();
    Guid myGuid = new();
    VillageBankGroup VillageBank { get; set; } = new();
    DialogOptions maxWidth = new DialogOptions() { MaxWidth = MaxWidth.Small, FullWidth = true, Position = DialogPosition.Center, DisableBackdropClick = true };
    async void ToggleDelete(InvestmentPeriod record)
    {
        var parameters = new DialogParameters();
        parameters.Add("ContentText", "this record");
        parameters.Add("DialogType", DialogType.Delete);
        var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.ExtraSmall, DisableBackdropClick = true };
        var dialog = dialogService.Show<SimpleDialog>("Delete", parameters, options);
        var response = await dialog.Result;
        if (!response.Cancelled)
        {
            if ((bool)response.Data)
            {
                //do the delete
                if (await investmentPeriodService.DeleteAsync(record))
                {
                    snackBar.Add("Record deleted successifully", Severity.Success);
                    DataSource = new();
                    DataSource = await investmentPeriodService.GetInvestmentPeriodsAsync(VillageBank.Id);
                    StateHasChanged();
                }
                else
                {
                    snackBar.Add("Something went wrong while trying to delete the record", Severity.Error);
                }
            }
        }

    }
    async void Activate(InvestmentPeriod period)
    {
        if (await investmentPeriodService.ToggleStatusAsync(period))
        {
            snackBar.Add("Operation Succeded", Severity.Success);
            DataSource = new();
            DataSource = await investmentPeriodService.GetInvestmentPeriodsAsync(VillageBank.Id);
        }
        else
        {
            snackBar.Add("Something went wrong..", Severity.Error);
        }

    }
    protected async override Task OnInitializedAsync()
    {
        claimsPrincipal = (await AuthenticationStateTask).User;
        if (claimsPrincipal.Identity.IsAuthenticated)
        {
            myGuid = await userService.GetGuid(claimsPrincipal.Identity.Name);
            var admin = await groupAdminService.GetByUserGuid(myGuid);
            VillageBank = admin.Group;
            DataSource = await investmentPeriodService.GetInvestmentPeriodsAsync(VillageBank.Id);

        }
    }
    async void ToggleEdit(InvestmentPeriod record)
    {
        var parameters = new DialogParameters { ["VillageBankId"] = VillageBank.Id,["Model"]=record,["IsEditing"]=true };
        var dialog = dialogService.Show<AddPeriodModal>("Edit Record", parameters, maxWidth);
        var result = await dialog.Result;
        if(!result.Cancelled)
        {
            if((bool)result.Data)
            {
                DataSource = new();
                DataSource = await investmentPeriodService.GetInvestmentPeriodsAsync(VillageBank.Id);
            }
        }
        
    }
    async void ToggleAdd()
    {
        var parameters = new DialogParameters { ["VillageBankId"] = VillageBank.Id };
        var dialog = dialogService.Show<AddPeriodModal>("Add New Investment Period", parameters, maxWidth);
        var result = await dialog.Result;
        if(!result.Cancelled)
        {
            if((bool)result.Data)
            {
                DataSource = new();
                DataSource = await investmentPeriodService.GetInvestmentPeriodsAsync(VillageBank.Id);
            }
        }
    }
}